<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Mapbox Gl Draw Passing Mode (Demo)</title>

    <style>
      @import "https://unpkg.com/modern-normalize@1.0.0/modern-normalize.css";
      @import url("https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.css");
      @import url("https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.2.0/mapbox-gl-draw.css");
      @import url("https://unpkg.com/nprogress@0.2.0/nprogress.css");

      h1,
      p {
        font-family: Lato;
      }

      .map-wrapper {
        position: relative;
        width: 100vw;
        height: 100vh;
        overflow: hidden;
        border-radius: inherit;
      }

      #map {
        width: 100%;
        height: 100%;
      }

      .mapboxgl-ctrl-group button.passing_mode.point {
        background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8' standalone='no'%3F%3E%3Csvg xmlns:dc='http://purl.org/dc/elements/1.1/' xmlns:cc='http://creativecommons.org/ns%23' xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns%23' xmlns:svg='http://www.w3.org/2000/svg' xmlns='http://www.w3.org/2000/svg' xmlns:sodipodi='http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd' xmlns:inkscape='http://www.inkscape.org/namespaces/inkscape' width='20' height='20' viewBox='0 0 20 20' id='svg19167' version='1.1' inkscape:version='1.0.1 (3bc2e813f5, 2020-09-07)' sodipodi:docname='snap_point.svg'%3E%3Cdefs id='defs19169' /%3E%3Csodipodi:namedview id='base' pagecolor='%23ffffff' bordercolor='%23666666' borderopacity='1.0' inkscape:pageopacity='0.0' inkscape:pageshadow='2' inkscape:zoom='29.132799' inkscape:cx='11.46386' inkscape:cy='10.851091' inkscape:document-units='px' inkscape:current-layer='g842' showgrid='false' units='px' inkscape:window-width='1920' inkscape:window-height='1021' inkscape:window-x='0' inkscape:window-y='0' inkscape:window-maximized='1' inkscape:object-nodes='true' inkscape:document-rotation='0' inkscape:snap-grids='true' inkscape:snap-object-midpoints='false'%3E%3Cinkscape:grid type='xygrid' id='grid19715' /%3E%3C/sodipodi:namedview%3E%3Cmetadata id='metadata19172'%3E%3Crdf:RDF%3E%3Ccc:Work rdf:about=''%3E%3Cdc:format%3Eimage/svg+xml%3C/dc:format%3E%3Cdc:type rdf:resource='http://purl.org/dc/dcmitype/StillImage' /%3E%3Cdc:title /%3E%3C/cc:Work%3E%3C/rdf:RDF%3E%3C/metadata%3E%3Cg inkscape:label='Layer 1' inkscape:groupmode='layer' id='layer1' transform='translate(0,-1032.3622)'%3E%3Cg id='g845'%3E%3Cg id='g838' transform='translate(-1.269038,0.02805)'%3E%3Cg id='g842' transform='translate(-0.4997445,-0.00255)'%3E%3Cg id='g846' transform='translate(-0.311276,0.4745)'%3E%3Cpath style='opacity:1;fill:%23000000;fill-opacity:1;stroke:none;stroke-width:2;stroke-linecap:butt;stroke-linejoin:bevel;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;marker:none' d='M 10,2 C 6.686292,2 4,4.6863 4,8 c 0,3.3137 6,9 6,9 0,0 6,-5.6863 6,-9 0,-3.3137 -2.686292,-6 -6,-6 z m 0,2 c 2.071068,0 3.75,1.6789 3.75,3.75 0,1.4553278 -1.81889,3.894393 -2.919922,5.25 H 9.1699219 C 8.0688903,11.644393 6.25,9.2053278 6.25,7.75 6.25,5.6789 7.928932,4 10,4 Z' transform='translate(0,1032.3622)' id='path17305' /%3E%3Cpath d='m 17.798825,1044.3235 a 2.3612922,2.361292 0 1 0 2.361292,2.3613 2.3612922,2.361292 0 0 0 -2.361292,-2.3613 z m 0.708388,2.5974 h -1.416776 a 0.23612922,0.2361292 0 0 1 0,-0.4722 h 1.416776 a 0.23612922,0.2361292 0 0 1 0,0.4722 z' id='path842' style='fill:%23ff2a2a;stroke-width:0.236129' /%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/g%3E%3Cpath style='color:%23000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:%23000000;solid-opacity:1;fill:%23ffffff;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;marker:none;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate' d='m 34.000115,1040.3622 c -5e-6,2.2062 -3.992523,7.0001 -3.992523,7.0001 0,0 -3.999291,-4.7787 -4.007679,-6.9849 -0.0084,-2.2062 1.771082,-4.0027 3.97731,-4.0153 2.20621,-0.013 4.006037,1.7635 4.022777,3.9697' id='path12563' inkscape:connector-curvature='0' sodipodi:nodetypes='cccsc' /%3E%3Cpath style='color:%23000000;clip-rule:nonzero;display:inline;overflow:visible;visibility:visible;opacity:1;isolation:auto;mix-blend-mode:normal;color-interpolation:sRGB;color-interpolation-filters:linearRGB;solid-color:%23000000;solid-opacity:1;fill:%23ffffff;fill-opacity:1;fill-rule:evenodd;stroke:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-dashoffset:0;stroke-opacity:1;marker:none;color-rendering:auto;image-rendering:auto;shape-rendering:auto;text-rendering:auto;enable-background:accumulate' d='m 34.000115,1040.3622 c -5e-6,2.2062 -3.992523,7.0001 -3.992523,7.0001 0,0 -3.999291,-4.7787 -4.007679,-6.9849 -0.0084,-2.2062 1.771082,-4.0027 3.97731,-4.0153 2.20621,-0.013 4.006037,1.7635 4.022777,3.9697' id='path841' inkscape:connector-curvature='0' sodipodi:nodetypes='cccsc' /%3E%3C/g%3E%3C/svg%3E%0A");
      }

      .mapboxgl-ctrl-group button.passing_mode.line {
        background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8' standalone='no'%3F%3E%3Csvg xmlns:dc='http://purl.org/dc/elements/1.1/' xmlns:cc='http://creativecommons.org/ns%23' xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns%23' xmlns:svg='http://www.w3.org/2000/svg' xmlns='http://www.w3.org/2000/svg' xmlns:sodipodi='http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd' xmlns:inkscape='http://www.inkscape.org/namespaces/inkscape' width='20' height='20' viewBox='0 0 20 20' id='svg19167' version='1.1' inkscape:version='1.0.1 (3bc2e813f5, 2020-09-07)' sodipodi:docname='snap_line.svg'%3E%3Cdefs id='defs19169' /%3E%3Csodipodi:namedview id='base' pagecolor='%23ffffff' bordercolor='%23666666' borderopacity='1.0' inkscape:pageopacity='0.0' inkscape:pageshadow='2' inkscape:zoom='16' inkscape:cx='-0.601225' inkscape:cy='9.5890152' inkscape:document-units='px' inkscape:current-layer='g842' showgrid='true' units='px' inkscape:window-width='1920' inkscape:window-height='1021' inkscape:window-x='0' inkscape:window-y='0' inkscape:window-maximized='1' inkscape:object-nodes='true' inkscape:document-rotation='0'%3E%3Cinkscape:grid type='xygrid' id='grid19715' /%3E%3C/sodipodi:namedview%3E%3Cmetadata id='metadata19172'%3E%3Crdf:RDF%3E%3Ccc:Work rdf:about=''%3E%3Cdc:format%3Eimage/svg+xml%3C/dc:format%3E%3Cdc:type rdf:resource='http://purl.org/dc/dcmitype/StillImage' /%3E%3Cdc:title /%3E%3C/cc:Work%3E%3C/rdf:RDF%3E%3C/metadata%3E%3Cg inkscape:label='Layer 1' inkscape:groupmode='layer' id='layer1' transform='translate(0,-1032.3622)'%3E%3Cg id='g840'%3E%3Cg id='g842' transform='translate(-0.3843915,-0.73725)'%3E%3Cg id='g843' transform='translate(-0.634256,0.556108)'%3E%3Cpath style='color:%23000000;display:inline;overflow:visible;visibility:visible;fill:%23000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:3;marker:none;enable-background:accumulate' d='m 13.5,1035.8622 c -1.380712,0 -2.5,1.1193 -2.5,2.5 0,0.3208 0.04614,0.6244 0.15625,0.9063 l -3.75,3.75 c -0.281836,-0.1102 -0.585421,-0.1563 -0.90625,-0.1563 -1.380712,0 -2.5,1.1193 -2.5,2.5 0,1.3807 1.119288,2.5 2.5,2.5 1.380712,0 2.5,-1.1193 2.5,-2.5 0,-0.3208 -0.04614,-0.6244 -0.15625,-0.9062 l 3.75,-3.75 c 0.281836,0.1101 0.585421,0.1562 0.90625,0.1562 1.380712,0 2.5,-1.1193 2.5,-2.5 0,-1.3807 -1.119288,-2.5 -2.5,-2.5 z' id='rect6467' inkscape:connector-curvature='0' /%3E%3Cpath d='m 15.676004,1044.5019 a 2.3612922,2.361292 0 1 0 2.361291,2.3614 2.3612922,2.361292 0 0 0 -2.361291,-2.3614 z m 0.708387,2.5976 h -1.416776 a 0.23615002,0.23615 0 0 1 0,-0.4723 h 1.416776 a 0.23615002,0.23615 0 0 1 0,0.4723 z' id='path842' style='fill:%23ff2a2a;stroke-width:0.236129' /%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E%0A");
      }

      .mapboxgl-ctrl-group button.passing_mode.polygon {
        background-image: url("data:image/svg+xml,%3C%3Fxml version='1.0' encoding='UTF-8' standalone='no'%3F%3E%3Csvg xmlns:dc='http://purl.org/dc/elements/1.1/' xmlns:cc='http://creativecommons.org/ns%23' xmlns:rdf='http://www.w3.org/1999/02/22-rdf-syntax-ns%23' xmlns:svg='http://www.w3.org/2000/svg' xmlns='http://www.w3.org/2000/svg' xmlns:sodipodi='http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd' xmlns:inkscape='http://www.inkscape.org/namespaces/inkscape' width='20' height='20' viewBox='0 0 20 20' id='svg19167' version='1.1' inkscape:version='1.0.1 (3bc2e813f5, 2020-09-07)' sodipodi:docname='snap_polygon.svg'%3E%3Cdefs id='defs19169' /%3E%3Csodipodi:namedview id='base' pagecolor='%23ffffff' bordercolor='%23666666' borderopacity='1.0' inkscape:pageopacity='0.0' inkscape:pageshadow='2' inkscape:zoom='29.671711' inkscape:cx='12.519141' inkscape:cy='8.9294617' inkscape:document-units='px' inkscape:current-layer='g844' showgrid='true' units='px' inkscape:window-width='1920' inkscape:window-height='1021' inkscape:window-x='0' inkscape:window-y='0' inkscape:window-maximized='1' inkscape:object-nodes='true' inkscape:document-rotation='0'%3E%3Cinkscape:grid type='xygrid' id='grid19715' /%3E%3C/sodipodi:namedview%3E%3Cmetadata id='metadata19172'%3E%3Crdf:RDF%3E%3Ccc:Work rdf:about=''%3E%3Cdc:format%3Eimage/svg+xml%3C/dc:format%3E%3Cdc:type rdf:resource='http://purl.org/dc/dcmitype/StillImage' /%3E%3Cdc:title /%3E%3C/cc:Work%3E%3C/rdf:RDF%3E%3C/metadata%3E%3Cg inkscape:label='Layer 1' inkscape:groupmode='layer' id='layer1' transform='translate(0,-1032.3622)'%3E%3Cg id='g854' transform='matrix(0.8940999,0,0,0.8455735,0.06277299,159.87587)'%3E%3Cg id='g862'%3E%3Cg id='g876' transform='translate(-0.346581,-0.47809685)'%3E%3Cg id='g870' transform='translate(1.3051702,0.70675572)'%3E%3Cg data-name='minus-circle' id='g844' transform='matrix(0.13980544,0,0,0.14782869,14.95594,1046.941)' style='fill:%23ff2a2a'%3E%3Cg id='g893' transform='translate(-9.4438044,-0.61034979)'%3E%3Cpath inkscape:connector-curvature='0' style='color:%23000000;display:inline;overflow:visible;visibility:visible;fill:%23000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:0.5;marker:none;enable-background:accumulate' d='m 3,1039.3622 v 6 l 2,2 h 6 l 2,-2 v -6 l -2,-2 H 5 Z m 3,0 h 4 l 1,1 v 4 l -1,1 H 6 l -1,-1 v -4 z' id='rect7797' sodipodi:nodetypes='cccccccccccccccccc' transform='matrix(7.1527975,0,0,6.7645868,-106.97681,-7082.1232)' /%3E%3Ccircle style='color:%23000000;display:inline;overflow:visible;visibility:visible;fill:%23000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:1.6;marker:none;enable-background:accumulate' id='path4364' cx='4' cy='1046.3622' r='2' transform='matrix(7.1527975,0,0,6.7645868,-106.97681,-7082.1232)' /%3E%3Ccircle id='path4368' style='color:%23000000;display:inline;overflow:visible;visibility:visible;fill:%23000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:1.6;marker:none;enable-background:accumulate' cx='12' cy='1046.3622' r='2' transform='matrix(7.1527975,0,0,6.7645868,-106.97681,-7082.1232)' /%3E%3Ccircle id='path4370' style='color:%23000000;display:inline;overflow:visible;visibility:visible;fill:%23000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:1.6;marker:none;enable-background:accumulate' cx='4' cy='1038.3622' r='2' transform='matrix(7.1527975,0,0,6.7645868,-106.97681,-7082.1232)' /%3E%3Ccircle style='color:%23000000;display:inline;overflow:visible;visibility:visible;fill:%23000000;fill-opacity:1;fill-rule:nonzero;stroke:none;stroke-width:1.6;marker:none;enable-background:accumulate' id='path4372' cx='12' cy='1038.3622' r='2' transform='matrix(7.1527975,0,0,6.7645868,-106.97681,-7082.1232)' /%3E%3Crect width='24' height='24' opacity='0' id='rect840' x='0' y='0' style='fill:%23ff2a2a' /%3E%3Cpath d='M 23.997277,-12.560035 A 18.890333,18.890333 0 1 0 42.887609,6.3302969 18.890333,18.890333 0 0 0 23.997277,-12.560035 Z m 5.6671,20.7793651 h -11.3342 a 1.8890333,1.8890333 0 0 1 0,-3.7780665 h 11.3342 a 1.8890333,1.8890333 0 0 1 0,3.7780665 z' id='path842' style='fill:%23ff2a2a;stroke-width:1.88903' /%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/g%3E%3C/svg%3E%0A");
      }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/v1.12.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.0.9/mapbox-gl-draw.js"></script>
    <script src="https://unpkg.com/mapbox-gl-draw-passing-mode"></script>

    <script type="module">
      import nprogress from "https://cdn.skypack.dev/nprogress";
      window.nprogress = nprogress;
      nprogress.start();
    </script>

    <script type="text/babel" data-type="module">
      import React, {
        useRef,
        useState,
        useEffect,
      } from "https://cdn.skypack.dev/react";
      import ReactDOM from "https://cdn.skypack.dev/react-dom";

      class extendDrawBar {
        constructor(opt) {
          let ctrl = this;
          ctrl.draw = opt.draw;
          ctrl.buttons = opt.buttons || [];
          ctrl.onAddOrig = opt.draw.onAdd;
          ctrl.onRemoveOrig = opt.draw.onRemove;
        }
        onAdd(map) {
          let ctrl = this;
          ctrl.map = map;
          ctrl.elContainer = ctrl.onAddOrig(map);
          ctrl.buttons.forEach((b) => {
            ctrl.addButton(b);
          });
          return ctrl.elContainer;
        }
        onRemove(map) {
          ctrl.buttons.forEach((b) => {
            ctrl.removeButton(b);
          });
          ctrl.onRemoveOrig(map);
        }
        addButton(opt) {
          let ctrl = this;
          const elButton = document.createElement("button");
          elButton.className = "mapbox-gl-draw_ctrl-draw-btn";
          elButton.setAttribute("title", opt.title);
          if (opt.classes instanceof Array) {
            opt.classes.forEach((c) => {
              elButton.classList.add(c);
            });
          }
          elButton.addEventListener(opt.on, opt.action);
          ctrl.elContainer.appendChild(elButton);
          opt.elButton = elButton;
        }
        removeButton(opt) {
          opt.elButton.removeEventListener(opt.on, opt.action);
          opt.elButton.remove();
        }
      }

      export default function App() {
        if (mapboxgl.getRTLTextPluginStatus() === "unavailable")
          mapboxgl.setRTLTextPlugin(
            "https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-rtl-text/v0.2.3/mapbox-gl-rtl-text.js",
            (err) => {
              err && console.error(err);
            },
            true
          );
        let mapRef = useRef(null);

        useEffect(() => {
          const map = new mapboxgl.Map({
            container: mapRef.current || "",
            style: `https://map.ir/vector/styles/main/mapir-xyz-light-style.json`,
            center: [51.3857, 35.6102],
            zoom: 10,
            pitch: 0,
            interactive: true,
            hash: true,
            attributionControl: true,
            transformRequest: (url) => {
              return {
                url: url,
                headers: {
                  "x-api-key":
                    "eyJ0eXAiOiJKV1QiLCJhbGciOiJSUzI1NiIsImp0aSI6ImRiZWU0YWU4OTk4OTA3MmQ3OTFmMjQ4ZDE5N2VhZTgwZWU2NTUyYjhlYjczOWI2NDdlY2YyYzIzNWRiYThiMzIzOTM5MDkzZDM0NTY2MmU3In0.eyJhdWQiOiI5NDMyIiwianRpIjoiZGJlZTRhZTg5OTg5MDcyZDc5MWYyNDhkMTk3ZWFlODBlZTY1NTJiOGViNzM5YjY0N2VjZjJjMjM1ZGJhOGIzMjM5MzkwOTNkMzQ1NjYyZTciLCJpYXQiOjE1OTA4MjU0NzIsIm5iZiI6MTU5MDgyNTQ3MiwiZXhwIjoxNTkzNDE3NDcyLCJzdWIiOiIiLCJzY29wZXMiOlsiYmFzaWMiXX0.M_z4xJlJRuYrh8RFe9UrW89Y_XBzpPth4yk3hlT-goBm8o3x8DGCrSqgskFfmJTUD2wC2qSoVZzQKB67sm-swtD5fkxZO7C0lBCMAU92IYZwCdYehIOtZbP5L1Lfg3C6pxd0r7gQOdzcAZj9TStnKBQPK3jSvzkiHIQhb6I0sViOS_8JceSNs9ZlVelQ3gs77xM2ksWDM6vmqIndzsS-5hUd-9qdRDTLHnhdbS4_UBwNDza47Iqd5vZkBgmQ_oDZ7dVyBuMHiQFg28V6zhtsf3fijP0UhePCj4GM89g3tzYBOmuapVBobbX395FWpnNC3bYg7zDaVHcllSUYDjGc1A",
                  "Mapir-SDK": "reactjs",
                },
              };
            },
          });

          const draw = new MapboxDraw({
            modes: {
              ...MapboxDraw.modes,
              passing_mode_point: mapboxGlDrawPassingMode(
                MapboxDraw.modes.draw_point
              ),
              passing_mode_line_string: mapboxGlDrawPassingMode(
                MapboxDraw.modes.draw_line_string,
                (feature) => {
                  console.log(feature);
                  alert("Drawn feature logged, check the console.");
                }
              ),
              passing_mode_polygon: mapboxGlDrawPassingMode(
                MapboxDraw.modes.draw_polygon
              ),
            },
          });

          map.on("draw.stall.create", (info) => {
            console.info("draw.stall.create", info);
          });

          map.once("load", () => {
            nprogress.done();
            map.resize();

            const drawBar = new extendDrawBar({
              draw: draw,
              buttons: [
                {
                  on: "click",
                  action: () => {
                    draw.changeMode("passing_mode_point");
                  },
                  classes: ["passing_mode", "point"],
                  title: "Passing-Point tool",
                },
                {
                  on: "click",
                  action: () => {
                    draw.changeMode("passing_mode_line_string", (info) => {
                      console.log(info);
                    });
                  },
                  classes: ["passing_mode", "line"],
                  title: "Passing-LineString tool",
                },
                {
                  on: "click",
                  action: () => {
                    draw.changeMode("passing_mode_polygon");
                  },
                  classes: ["passing_mode", "polygon"],
                  title: "Passing-Polygon tool",
                },
              ],
            });

            map.addControl(drawBar, "top-right");

            // draw.set({
            //   type: "FeatureCollection",
            //   features: [
            //     {
            //       type: "Feature",
            //       properties: {},
            //       id: "example-id",
            //       geometry: {
            //         type: "Polygon",
            //         coordinates: [
            //           [
            //             [51.41742415918904, 35.73019558439101],
            //             [51.31319413385742, 35.702773908694724],
            //             [51.378997493472525, 35.665562843119986],
            //             [51.45008537540798, 35.67776544979942],
            //             [51.46619566741822, 35.70822028156377],
            //             [51.41742415918904, 35.73019558439101],
            //           ],
            //         ],
            //       },
            //     },
            //   ],
            // });
          });
        }, []);

        return (
          <div className="map-wrapper">
            <div id="map" ref={mapRef} />
          </div>
        );
      }

      ReactDOM.render(<App />, document.getElementById("root"));
    </script>
  </body>
</html>
